

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="/img/favicon.ico">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#FDD962">
  <meta name="description" content="殷超的个人博客">
  <meta name="author" content="Yin Chao">
  <meta name="keywords" content="">
  <title>Java 知识 -- 锁 ~ y·◑</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/atom-one-dark-reasonable.min.css" />
    
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_pf9vaxs7x7b.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="y·◑" type="application/atom+xml">
</head>


<body>
  <header style="height: 110vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong><img src="/img/avatar.jpg" srcset="/img/loading.gif" style="width:20px; height:20px;"> c</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('http://cdn.yinchao.tech/Java%20%E4%B8%AD%E7%9A%84%E9%94%81.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              <div class="mt-3">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-author" aria-hidden="true"></i>
      Yin Chao
    </span>
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2020-12-11 01:22" pubdate>
        2020 十二月 11, 星期五 , 1:22 凌晨
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      997 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      16
       分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
            <div class="scroll-down-bar">
              <i class="iconfont icon-arrowdown"></i>
            </div>
          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">Java 知识 -- 锁</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：7 天前
                
              </p>
            
            <div class="markdown-body" id="post-body">
              <p><img src="http://cdn.yinchao.tech/Java%20%E4%B8%AD%E7%9A%84%E9%94%81.png" srcset="/img/loading.gif" alt="Java 中的锁"></p>
<ol>
<li>
<p>ReentrantLock</p>
<p>大部分 JDK 级别加锁+CAS(CPU指令,非常快)</p>
<p>只有在资源竞争,加锁失败的情况下,release CPU,才会阻塞线程</p>
<p>非公平</p>
</li>
<li>
<p>synchronize</p>
<ul>
<li>
<p>JDK 1.6 以前直接更改操作系统 -&gt; JDK 1.6 以后,首先通过对象头里面存储锁状态标识,升级为重量锁之后才调用操作系统代码</p>
</li>
<li>
<p>加锁过程:</p>
<ol>
<li>
<p>在代码进入同步块的时候，如果同步对象锁状态为无锁状态 ( <code>101</code>)（锁标志位为“01”状态，能否偏向为“1”），虚拟机首先将在当前线程的栈帧中建立一个名为锁记录(Lock Record)的空间，用于存储锁对象目前的Mark Word的拷贝，官方称之为 Displaced Mark Word。这时候线程堆栈与对象头的状态如图2.1所示。</p>
</li>
<li>
<p>拷贝对象头中的Mark Word复制到锁记录中。</p>
</li>
<li>
<p>拷贝成功后，虚拟机将使用CAS操作尝试将对象的Mark Word更新为指向Lock Record的指针，并将Lock record里的owner指针指向object mark word。如果更新成功，则执行步骤（4），否则执行步骤（5）。</p>
</li>
<li>
<p>如果这个更新动作成功了，那么这个线程就拥有了该对象的锁，并且对象Mark Word的锁标志位设置为“00”，即表示此对象处于轻量级锁定状态，这时候线程堆栈与对象头的状态如图2.2所示。</p>
</li>
<li>
<p>如果这个更新操作失败了，虚拟机首先会检查对象的Mark Word是否指向当前线程的栈帧，如果是就说明当前线程已经拥有了这个对象的锁，那就可以直接进入同步块继续执行。否则说明多个线程竞争锁，轻量级锁就要膨胀为重量级锁，锁标志的状态值变为“10”，Mark Word中存储的就是指向重量级锁（互斥量）的指针，后面等待锁的线程也要进入阻塞状态。 而当前线程便尝试使用自旋来获取锁，自旋就是为了不让线程阻塞，而采用循环去获取锁的过程。</p>
</li>
</ol>
</li>
</ul>
<p>// 无锁 可偏向 1 01 前52位存线程id(但是还没有存)+U1+4年龄+<br>
// 无锁 不可偏向 0 01  前56位存hashcode+u1+4年龄+<br>
计算了 hashcode不可能偏向<br>
// (已)偏向锁 1 01 前面52位存线程id+epoch<br>
// 轻量锁 0 00<br>
// 重量锁</p>
<p>偏向锁会记录当前线程 id</p>
<p>但是轻量锁不会记录</p>
<p>标识位 0 -&gt; 可以偏向<br>
1 -&gt; 不可以偏向</p>
<p>0 -&gt; 有没有偏向 -&gt; 有没有存线程 id</p>
<ul>
<li>
<p>偏向锁膨胀为轻量锁的条件:</p>
<ol>
<li>
<p>001 不可能偏向 -&gt; 000 升级为轻量锁</p>
</li>
<li>
<p>线程交替运行</p>
</li>
</ol>
</li>
<li>
<p>锁的膨胀一般是不可逆的</p>
<p>可逆和epoch有关</p>
</li>
</ul>
<p>对象锁和类锁是不一样的</p>
<p>对象在堆上,类信息则在方法区</p>
<p>所以 new 多个类,多个实例同时访问各自的对象锁就无效</p>
<p>例如:</p>
 <div class="hljs"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">synchronized</span> <span class="hljs-params">(<span class="hljs-keyword">this</span>)</span></span></code></pre></div>
<p>但是如果是类锁就不是这样的,</p>
</li>
</ol>
<hr>
<p>对象头</p>
<div class="hljs"><pre><code class="hljs gherkin">|<span class="hljs-string">       锁        </span>|<span class="hljs-string">                       62位                      </span>|<span class="hljs-string">锁状态</span>|<span class="hljs-string">                                     </span>|<span class="hljs-string">                           过程                        </span>|<span class="hljs-string">锁状态</span>|
|<span class="hljs-string">    无锁可偏向    </span>|<span class="hljs-string">          unused:57         </span>|<span class="hljs-string"> u1 </span>|<span class="hljs-string"> age:4 </span>|<span class="hljs-string">   1   </span>|<span class="hljs-string"> 01 </span>|<span class="hljs-string"> klass word (64,如果开启了指针压缩就是32) </span>|<span class="hljs-string">                        默认初始状态                     </span>|<span class="hljs-string"> 101 </span>|
|<span class="hljs-string">   无锁不可偏向   </span>|<span class="hljs-string">  unused: 25 </span>|<span class="hljs-string"> hashcode:31  </span>|<span class="hljs-string"> u1 </span>|<span class="hljs-string"> age:4 </span>|<span class="hljs-string">   0   </span>|<span class="hljs-string"> 01 </span>|<span class="hljs-string">               klass word             </span>|<span class="hljs-string">  计算了hashcode,保存了hashcode,但是没有地方存偏向锁的线程id了 </span>|<span class="hljs-string"> 001 </span>|
|<span class="hljs-string"> 有偏向锁,已经偏向 </span>|<span class="hljs-string"> thread(线程id): 54</span>|<span class="hljs-string"> epoch:2 </span>|<span class="hljs-string"> u1 </span>|<span class="hljs-string"> age:4 </span>|<span class="hljs-string">   1   </span>|<span class="hljs-string"> 01 </span>|<span class="hljs-string">               klass word             </span>|<span class="hljs-string">            默认状态到偏向锁状态,没有计算hashcode           </span>|<span class="hljs-string"> 101 </span>|
|<span class="hljs-string">      轻量锁     </span>|<span class="hljs-string">     ptr_to_lock_record(指向栈中锁记录的指针):62     </span>|<span class="hljs-string"> 00 </span>|<span class="hljs-string">               klass word             </span>|<span class="hljs-string">          线程交替执行,或者由无锁不可偏向状态升级而来          </span>|<span class="hljs-string"> 000 </span>|
|<span class="hljs-string">      重量锁     </span>|<span class="hljs-string"> ptr_to_heavyweight_monitor(指向重量锁记录的指针):62 </span>|<span class="hljs-string"> 10 </span>|<span class="hljs-string">               klass word             </span>|<span class="hljs-string"> 轻量锁抢锁失败,自旋锁自旋一段时间,如果还是抢锁失败则会变成重量锁 </span>|<span class="hljs-string"> ?10 </span>|</code></pre></div>
            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Java/">Java</a>
                    
                      <a class="hover-with-bg" href="/tags/concurrent/">concurrent</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a rel="license noopener" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a> 。转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2020/12/11/Java-%E7%9F%A5%E8%AF%86-synchronize/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Java 知识 -- synchronize</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/12/11/JVM-%E7%9F%A5%E8%AF%86-%E5%AF%B9%E8%B1%A1%E5%A4%B4/">
                        <span class="hidden-mobile">JVM 知识--对象头</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    <%- partial('_partial/statistics.ejs') %>
    <%- partial('_partial/beian.ejs') %>
    <% if(theme.web_analytics.cnzz) { %>
      <!-- cnzz Analytics Icon -->
      <span id="cnzz_stat_icon_<%- theme.web_analytics.cnzz %>" style="display: none"></span>
    <% } %>
  </div>
</footer>

<!-- SCRIPTS -->
<%- partial('_partial/scripts.ejs') %>


</body>
</html>
