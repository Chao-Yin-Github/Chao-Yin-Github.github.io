

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="/img/favicon.ico">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#FDD962">
  <meta name="description" content="殷超的个人博客">
  <meta name="author" content="Yin Chao">
  <meta name="keywords" content="">
  <title>JVM 知识--对象头 ~ y·◑</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/atom-one-dark-reasonable.min.css" />
    
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_pf9vaxs7x7b.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="y·◑" type="application/atom+xml">
</head>


<body>
  <header style="height: 110vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong><img src="/img/avatar.jpg" srcset="/img/loading.gif" style="width:20px; height:20px;"> c</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('http://cdn.yinchao.tech/Java%20%E5%AF%B9%E8%B1%A1%E5%A4%B4.jpeg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              <div class="mt-3">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-author" aria-hidden="true"></i>
      Yin Chao
    </span>
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2020-12-11 00:58" pubdate>
        2020 十二月 11, 星期五 , 12:58 凌晨
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      726 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      13
       分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
            <div class="scroll-down-bar">
              <i class="iconfont icon-arrowdown"></i>
            </div>
          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">JVM 知识--对象头</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：7 天前
                
              </p>
            
            <div class="markdown-body" id="post-body">
              <p><code>对象布局</code> =  对象头(16个byte=128bit) + 实例数据 + 对齐填充 (变成8的倍数)</p>
<p><code>对象头</code> = mark word(64bit) + klass pointer(64bit)</p>
<p><code>klass pointer</code>:指针指向元空间中保存类的模板信息的地址</p>
<blockquote>
<p>object header</p>
<p>Common structure at the beginning of every GC-managed heap object. (Every oop points to an object header.) Includes fundamental information about the heap object’s layout, type(类型), GC state (垃圾回收状态), synchronization state (同步状态), and identity hash code (hash code). Consists of two words(字长)(字长和机器有关,64位机字长就是64位). In arrays it is immediately followed by a length field. Note that both Java objects and VM-internal objects have a common object header format.</p>
<p>在每个gc管理的堆对象开始处的公共结构。(每个oop都指向一个对象头)。包括基本信息堆对象的布局、类型,GC状态,同步状态,和哈希值。对象头由两个 word (字长)(字长和机器有关,64位机字长就是64位)。在数组对象中，紧随其后的是长度字段。注意，Java 对象和 JVM 内部对象都有一个通用的对象头格式。</p>
</blockquote>
<p><img src="http://cdn.yinchao.tech/Java%20%E5%AF%B9%E8%B1%A1%E5%A4%B4.jpeg" srcset="/img/loading.gif" alt="Java 对象头"></p>
<p><code>oop</code>: Ordinary Object Pointer，就是普通对象指针。</p>
<p>启用CompressOops后，会压缩的对象：</p>
<ul>
<li>
<p>每个Class的属性指针（静态成员变量）；</p>
</li>
<li>
<p>每个对象的属性指针；</p>
</li>
<li>
<p>普通对象数组的每个元素指针。</p>
</li>
</ul>
<div class="hljs"><pre><code class="hljs gherkin">|<span class="hljs-string">--------------------------------------------------------------------------------------------------------------</span>|
|<span class="hljs-string">                                              Object Header (128 bits)                                        </span>|
|<span class="hljs-string">--------------------------------------------------------------------------------------------------------------</span>|
|<span class="hljs-string">                        Mark Word (64 bits)                                    </span>|<span class="hljs-string">      Klass Word (64 bits)    </span>|<span class="hljs-string">       </span>
|<span class="hljs-string">--------------------------------------------------------------------------------------------------------------</span>|
|<span class="hljs-string">  unused:25 </span>|<span class="hljs-string"> identity_hashcode:31 </span>|<span class="hljs-string"> unused:1 </span>|<span class="hljs-string"> age:4 </span>|<span class="hljs-string"> biased_lock:1 </span>|<span class="hljs-string"> lock:2 </span>|<span class="hljs-string">     OOP to metadata object   </span>|<span class="hljs-string">   无锁 01</span>
|<span class="hljs-string">----------------------------------------------------------------------</span>|<span class="hljs-string">--------</span>|<span class="hljs-string">------------------------------</span>|
|<span class="hljs-string">  thread:54 </span>|<span class="hljs-string">         epoch:2      </span>|<span class="hljs-string"> unused:1 </span>|<span class="hljs-string"> age:4 </span>|<span class="hljs-string"> biased_lock:1 </span>|<span class="hljs-string"> lock:2 </span>|<span class="hljs-string">     OOP to metadata object   </span>|<span class="hljs-string">  偏向锁 01</span>
|<span class="hljs-string">----------------------------------------------------------------------</span>|<span class="hljs-string">--------</span>|<span class="hljs-string">------------------------------</span>|
|<span class="hljs-string">                     ptr_to_lock_record:62                            </span>|<span class="hljs-string"> lock:2 </span>|<span class="hljs-string">     OOP to metadata object   </span>|<span class="hljs-string">  轻量锁 00</span>
|<span class="hljs-string">----------------------------------------------------------------------</span>|<span class="hljs-string">--------</span>|<span class="hljs-string">------------------------------</span>|
|<span class="hljs-string">                     ptr_to_heavyweight_monitor:62                    </span>|<span class="hljs-string"> lock:2 </span>|<span class="hljs-string">     OOP to metadata object   </span>|<span class="hljs-string">  重量锁 10</span>
|<span class="hljs-string">----------------------------------------------------------------------</span>|<span class="hljs-string">--------</span>|<span class="hljs-string">------------------------------</span>|
|<span class="hljs-string">                                                                      </span>|<span class="hljs-string"> lock:2 </span>|<span class="hljs-string">     OOP to metadata object   </span>|<span class="hljs-string">    GC 11</span>
|<span class="hljs-string">--------------------------------------------------------------------------------------------------------------</span>|</code></pre></div>
<p><img src="http://cdn.yinchao.tech/%E5%AF%B9%E8%B1%A1%E5%A4%B4.png" srcset="/img/loading.gif" alt="对象头"></p>
<p>注意:</p>
<ol>
<li>
<p>为什么要这么实现？</p>
<p>因为对象头信息是跟对象自身定义的数据结构无关的。这些信息所记录的状态是用于JVM对对象的管理的。更重要的是，不同状态的存储内容基本上是互斥的。所以基于节省空间的角度考虑，Mark Word 被设计成动态的。</p>
</li>
<li>
<p>JVM 默认大端存储</p>
<p>可以使用 jol 打印对象信息,不过注意,JVM默认是<code>大端存储</code>,所以注意顺序是锁标志位在输出的第一个八位数据的最后两位</p>
<p>例如:00000101 是打印的第一个字节,其中最后的<code>101</code>表示偏向锁</p>
</li>
<li>
<p>当对象的状态不是默认状态时，对象的hashcode不存储在对象头</p>
<p>当是轻量级锁/重量级锁时，JVM 会将对象的 mark word 复制一份到栈帧的 Lock Record 中。等线程释放该对象时，再重新复制给对象。</p>
</li>
<li>
<p>如果一个对象头中存在 hashcode，则无法使用偏向锁。</p>
<p>即：如果在锁对象加锁前计算了 hashCode ，且 hashCode 方法没有被重写，那么会把 hashCode 存储到 Mark Word 中，加锁不会使用偏向锁，而是轻量级锁。</p>
</li>
</ol>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/JVM/">JVM</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a rel="license noopener" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a> 。转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2020/12/11/Java%20%E7%9F%A5%E8%AF%86-%E9%94%81/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Java 知识 -- 锁</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/12/10/Java-%E7%9F%A5%E8%AF%86-volatile/">
                        <span class="hidden-mobile">Java 知识 -- volatile</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    <%- partial('_partial/statistics.ejs') %>
    <%- partial('_partial/beian.ejs') %>
    <% if(theme.web_analytics.cnzz) { %>
      <!-- cnzz Analytics Icon -->
      <span id="cnzz_stat_icon_<%- theme.web_analytics.cnzz %>" style="display: none"></span>
    <% } %>
  </div>
</footer>

<!-- SCRIPTS -->
<%- partial('_partial/scripts.ejs') %>


</body>
</html>
