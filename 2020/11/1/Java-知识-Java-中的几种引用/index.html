

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="/img/favicon.ico">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#FDD962">
  <meta name="description" content="殷超的个人博客">
  <meta name="author" content="Yin Chao">
  <meta name="keywords" content="">
  <title>Java 知识-- Java 中的几种引用 ~ y·◑</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/atom-one-dark-reasonable.min.css" />
    
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_pf9vaxs7x7b.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="y·◑" type="application/atom+xml">
</head>


<body>
  <header style="height: 110vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong><img src="/img/avatar.jpg" srcset="/img/loading.gif" style="width:20px; height:20px;"> c</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/img/post.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              <div class="mt-3">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-author" aria-hidden="true"></i>
      Yin Chao
    </span>
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2020-11-01 11:13" pubdate>
        2020 十一月 01, 星期日 , 11:13 上午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      1.2k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      19
       分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
            <div class="scroll-down-bar">
              <i class="iconfont icon-arrowdown"></i>
            </div>
          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">Java 知识-- Java 中的几种引用</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：2 个月前
                
              </p>
            
            <div class="markdown-body" id="post-body">
              <h2 id="强引用"><a class="header-anchor" href="#强引用">⚡</a>强引用</h2>
<ul>
<li>
<p>最常用的引用方式，垃圾收集器宁愿抛出 OOM 也不愿意回收它引用对象</p>
</li>
<li>
<p>与其它三种引用不同，强引用创建的强引用对象就是创建的对象本身，而其他都会创建对应的软/弱/虚对象后，再去引用实际对象。</p>
</li>
</ul>
<h2 id="软引用-SoftReference"><a class="header-anchor" href="#软引用-SoftReference">⚡</a>软引用 (SoftReference)</h2>
<ul>
<li>
<p>如果内存空间不足了，垃圾收集器就会回收相应对象的内存。</p>
</li>
<li>
<p>可以通过 get() 方法获取引用的实际对象</p>
</li>
<li>
<p>使用场景：实现内存敏感的高速缓存。</p>
</li>
</ul>
<p>软引用可以和一个引用队列( ReferenceQueue )联合使用，当软引用对象指向的对象已经被被回收时(<strong>非这个软引用对象自身</strong>)，JVM 就会把这个软引用(这个软引用自身)加入到与之关联的引用队列中。</p>
<h2 id="弱引用-WeakReference"><a class="header-anchor" href="#弱引用-WeakReference">⚡</a>弱引用 (WeakReference)</h2>
<ul>
<li>垃圾收集器一旦发现了弱引用对象就会把他回收</li>
</ul>
<p>同软引用一样，弱引用也可以和一个引用队列一起使用</p>
<h2 id="虚引用-PhantomReference"><a class="header-anchor" href="#虚引用-PhantomReference">⚡</a>虚引用 (PhantomReference)</h2>
<ul>
<li>
<p>与其他几种引用不同，虚引用不会决定对象的生命周期。如果一个对象被虚引用持有，那么它就和没有任何引用一样，随时可能被垃圾收集器回收。</p>
</li>
<li>
<p>虚引用和软/弱引用的区别:</p>
<p>官方注释</p>
<blockquote>
<p>Phantom reference objects, which are enqueued after the collector determines that their referents may otherwise be reclaimed. Phantom references are most often used for scheduling pre-mortem cleanup actions in a more flexible way than is possible with the Java finalization mechanism.</p>
<p>虚拟引用对象，在收集器确定其引用对象可以通过其他方式回收之后，将其排队。与 Java finalize 机制相比，虚引用最常用于以更灵活的方式用事前清理操作。</p>
<p>If the garbage collector determines at a certain point in time that the referent of a phantom reference is phantom reachable, then at that time or at some later time it will enqueue the reference.</p>
<p>如果垃圾收集器在某个时间点确定幻像引用的引用对象是虚引用是可达的，则在那时或以后的某个时间，它将使该引用入队。</p>
<p>In order to ensure that a reclaimable object remains so, the referent of a phantom reference may not be retrieved: The get method of a phantom reference always returns null.</p>
<p>为了确保保留可回收对象，可能不会检索幻像引用的引用对象：幻像引用的get方法始终返回null。</p>
<p>Unlike soft and weak references, phantom references are not automatically cleared by the garbage collector as they are enqueued. An object that is reachable via phantom references will remain so until all such references are cleared or themselves become unreachable.</p>
<p>与软引用和弱引用不同，幻象引用在排队时不会被垃圾收集器自动清除。通过幻像引用可访问的对象将保持不变，直到清除所有此类引用或它们自身无法访问为止。</p>
</blockquote>
<p>总结：</p>
<ol>
<li>
<p>不会主动回收对象</p>
</li>
<li>
<p>get 永远为 null</p>
</li>
</ol>
</li>
<li>
<p>JDK 的应用</p>
<p>JDK 中直接内存的回收就用到虚引用。</p>
<p>由于 JVM 自动内存管理的范围是堆内存，而直接内存是在堆内存之外（其实是内存映射文件，自行去理解虚拟内存空间的相关概念），所以直接内存的分配和回收都是由 Unsafe 类去操作。</p>
<p>Java 在申请一块直接内存之后，在堆上再生成一个 DirectByteBuffer 对象存储直接内存的地址，其内部有一个静态类 Deallocator 实现了 Runnable 接口，并维护一个对 DirectByteBuffer 这个对象的虚引用。</p>
<p>当 DirectByteBuffer 对象被 GC 回收时，Deallocator 会通过虚引用得到通知，创建一个线程释放该 DirectByteBuffer 对象 malloc 申请的直接内存空间。</p>
<ul>
<li>
<p>为什么使用 DirectByteBuffer</p>
<ol>
<li>
<p>减少复制操作，加快传输速度</p>
<p>HotSpot虚拟机中，GC除了CMS算法之外，都需要移动对象。</p>
<p>在NIO实现中(如: FileChannel.read(ByteBuffer dst), FileChannel.write(ByteByffer src)), <strong>底层要求连续的内存，且使用期间不得变动</strong>， 如果提供的 Buffer 是 HeapByteBuffer，为了保证在数据传输时，被传输的 byte 数组背后的对象不会被 GC 回收或者移动，JVM 会首先将堆中的 byte 数组拷贝至直接内存，再由直接内存进行传输。</p>
<p>那么，相比于 HeapByteBuffer 在堆上分配空间，直接只用 DirectByteBuffer 在直接内存分配就节省了一次拷贝，加快了数据传输的速度。</p>
</li>
<li>
<p>减少GC压力</p>
<p>虽然 GC 仍然管理 DirectByteBuffer，但基于 DirectByteBuffer 分配的空间不属于 GC 管理，如果 IO 数量较大，可以明显降低 GC 压力。</p>
</li>
</ol>
</li>
</ul>
</li>
</ul>
<p><a href="https://www.ktanx.com/blog/p/313" target="_blank" rel="noopener">参考博客</a></p>
<p><a href="https://docs.oracle.com/javase/8/docs/api/java/lang/ref/PhantomReference.html" target="_blank" rel="noopener">Java Doc</a></p>
<p><a href="https://cheng-dp.github.io/2018/12/11/direct-memory-and-direct-byte-buffer/#%E4%B8%BA%E4%BB%80%E4%B9%88%E7%94%A8directbytebuffer" target="_blank" rel="noopener">虚引用在 NIO 中的应用</a></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Java/">Java</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a rel="license noopener" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a> 。转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2020/11/1/JVM%E7%9F%A5%E8%AF%86-%E6%8C%87%E9%92%88%E3%80%81%E5%BC%95%E7%94%A8%E5%92%8C%E5%8F%A5%E6%9F%84/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">JVM 知识-- 指针、引用和句柄</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/10/20/%E5%88%86%E5%B8%83%E5%BC%8F%E7%9F%A5%E8%AF%86-%E5%88%86%E5%B8%83%E5%BC%8F%E6%A6%82%E5%BF%B5/">
                        <span class="hidden-mobile">分布式知识 -- 分布式概念</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    <%- partial('_partial/statistics.ejs') %>
    <%- partial('_partial/beian.ejs') %>
    <% if(theme.web_analytics.cnzz) { %>
      <!-- cnzz Analytics Icon -->
      <span id="cnzz_stat_icon_<%- theme.web_analytics.cnzz %>" style="display: none"></span>
    <% } %>
  </div>
</footer>

<!-- SCRIPTS -->
<%- partial('_partial/scripts.ejs') %>


</body>
</html>
